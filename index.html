<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>IoT Dashboard - Water Level Monitor</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap");
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family: "Inter", sans-serif;
        background: linear-gradient(
          135deg,
          #0c0c1e 0%,
          #1a1a2e 30%,
          #16213e 70%,
          #0f3460 100%
        );
        min-height: 100vh;
        color: #e2e8f0;
        overflow-x: hidden;
      }
      .app-container {
        display: flex;
        min-height: 100vh;
      }
      .main-content {
        flex: 1;
        margin-left: 0;
        padding: 25px 40px;
        max-width: 1400px;
        margin: 0 auto;
      }
      .header {
        background: rgba(15, 23, 42, 0.98);
        backdrop-filter: blur(25px);
        border-radius: 25px;
        padding: 35px 45px;
        margin-bottom: 35px;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.6);
        border: 1px solid rgba(59, 130, 246, 0.3);
        position: relative;
        overflow: hidden;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .discord-btn {
        background: linear-gradient(135deg, #5865f2, #4752c4);
        color: white;
        border: none;
        width: 50px;
        height: 50px;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5em;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(88, 101, 242, 0.4);
      }
      .discord-btn:hover {
        transform: scale(1.1);
        box-shadow: 0 6px 20px rgba(88, 101, 242, 0.6);
      }
      .modal {
        display: none;
        position: fixed;
        z-index: 2000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.8);
        animation: fadeIn 0.3s ease;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }
      .modal-content {
        background: rgba(15, 23, 42, 0.98);
        margin: 10% auto;
        padding: 40px;
        border: 1px solid rgba(88, 101, 242, 0.3);
        border-radius: 25px;
        width: 90%;
        max-width: 500px;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.8);
        animation: slideIn 0.3s ease;
      }
      @keyframes slideIn {
        from {
          transform: translateY(-50px);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }
      .modal-content h2 {
        color: #e2e8f0;
        margin-bottom: 20px;
        font-size: 1.5em;
      }
      .modal-content input {
        width: 100%;
        padding: 15px;
        margin-bottom: 20px;
        background: rgba(59, 130, 246, 0.1);
        border: 1px solid rgba(59, 130, 246, 0.3);
        border-radius: 10px;
        color: #e2e8f0;
        font-size: 0.95em;
        box-sizing: border-box;
      }
      .modal-content input:focus {
        outline: none;
        border-color: rgba(88, 101, 242, 0.6);
        background: rgba(59, 130, 246, 0.15);
      }
      .modal-content input::placeholder {
        color: #64748b;
      }
      .modal-buttons {
        display: flex;
        gap: 15px;
        justify-content: flex-end;
      }
      .modal-btn {
        padding: 12px 25px;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s ease;
      }
      .modal-btn.save {
        background: linear-gradient(135deg, #5865f2, #4752c4);
        color: white;
      }
      .modal-btn.save:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(88, 101, 242, 0.4);
      }
      .modal-btn.cancel {
        background: rgba(59, 130, 246, 0.1);
        color: #e2e8f0;
        border: 1px solid rgba(59, 130, 246, 0.3);
      }
      .modal-btn.cancel:hover {
        background: rgba(59, 130, 246, 0.2);
      }
      .discord-status {
        font-size: 0.85em;
        color: #94a3b8;
        margin-top: 10px;
      }
      .discord-status.connected {
        color: #22c55e;
      }
      .position-config {
        background: rgba(15, 23, 42, 0.98);
        backdrop-filter: blur(25px);
        border-radius: 25px;
        padding: 30px;
        margin-bottom: 35px;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.6);
        border: 1px solid rgba(59, 130, 246, 0.3);
      }
      .position-config h3 {
        color: #e2e8f0;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .position-inputs {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 20px;
      }
      @media (max-width: 768px) {
        .position-inputs {
          grid-template-columns: 1fr;
        }
      }
      .input-group {
        display: flex;
        gap: 10px;
        align-items: center;
      }
      .input-group input {
        flex: 1;
        padding: 12px 15px;
        background: rgba(59, 130, 246, 0.1);
        border: 1px solid rgba(59, 130, 246, 0.3);
        border-radius: 10px;
        color: #e2e8f0;
        font-size: 0.95em;
      }
      .input-group input:focus {
        outline: none;
        border-color: rgba(88, 101, 242, 0.6);
        background: rgba(59, 130, 246, 0.15);
      }
      .input-group input::placeholder {
        color: #64748b;
      }
      .unit-label {
        color: #94a3b8;
        font-weight: 600;
        min-width: 40px;
        text-align: right;
      }
      .save-position-btn {
        background: linear-gradient(135deg, #3b82f6, #2563eb);
        color: white;
        border: none;
        padding: 12px 30px;
        border-radius: 10px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4);
      }
      .save-position-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(59, 130, 246, 0.6);
      }
      .status-bar {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 25px;
        margin-bottom: 35px;
      }
      .status-card {
        background: rgba(15, 23, 42, 0.98);
        backdrop-filter: blur(25px);
        border-radius: 25px;
        padding: 30px;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.6);
        border: 1px solid rgba(59, 130, 246, 0.3);
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
      }
      .status-card::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, #3b82f6, #8b5cf6, #06b6d4);
        border-radius: 25px 25px 0 0;
      }
      .status-card:hover {
        transform: translateY(-10px) scale(1.02);
        box-shadow: 0 35px 70px rgba(59, 130, 246, 0.5);
      }
      .status-card.warning::before {
        background: linear-gradient(90deg, #ef4444, #dc2626);
      }
      .status-card .icon {
        font-size: 3em;
        margin-bottom: 18px;
        background: linear-gradient(135deg, #60a5fa, #3b82f6);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
      }
      .status-card .value {
        font-size: 2.8em;
        font-weight: 700;
        color: #e2e8f0;
        margin-bottom: 10px;
      }
      .status-card .label {
        color: #94a3b8;
        font-size: 0.95em;
        text-transform: uppercase;
        letter-spacing: 1px;
        font-weight: 500;
      }
      .warning-indicator {
        background: linear-gradient(135deg, #ef4444, #dc2626);
        color: white;
        padding: 8px 15px;
        border-radius: 25px;
        font-size: 0.85em;
        margin-top: 12px;
        display: inline-block;
        animation: warning-pulse 2s infinite;
        font-weight: 600;
      }
      .warning-indicator.level1 {
        background: linear-gradient(135deg, #f59e0b, #d97706);
      }
      .warning-indicator.level2 {
        background: linear-gradient(135deg, #ef4444, #dc2626);
      }
      .warning-indicator.level3 {
        background: linear-gradient(135deg, #7c3aed, #6d28d9);
        animation: warning-pulse-intense 1s infinite;
      }
      @keyframes warning-pulse-intense {
        0%,
        100% {
          opacity: 1;
          transform: scale(1);
        }
        50% {
          opacity: 0.6;
          transform: scale(1.1);
        }
      }
      @keyframes warning-pulse {
        0%,
        100% {
          opacity: 1;
          transform: scale(1);
        }
        50% {
          opacity: 0.8;
          transform: scale(1.05);
        }
      }
      .charts-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 35px;
        margin-bottom: 35px;
      }
      @media (max-width: 1200px) {
        .charts-grid {
          grid-template-columns: 1fr;
        }
        .main-content {
          padding: 20px;
        }
      }
      .chart-container {
        background: rgba(15, 23, 42, 0.98);
        backdrop-filter: blur(25px);
        border-radius: 25px;
        padding: 35px;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.6);
        border: 1px solid rgba(59, 130, 246, 0.3);
        transition: all 0.3s ease;
      }
      .chart-container:hover {
        transform: translateY(-5px);
        box-shadow: 0 35px 70px rgba(59, 130, 246, 0.4);
      }
      .chart-title {
        font-size: 1.5em;
        font-weight: 600;
        margin-bottom: 25px;
        color: #e2e8f0;
        text-align: center;
      }
      .chart-wrapper {
        position: relative;
        height: 350px;
      }
      .controls {
        display: flex;
        justify-content: center;
        gap: 25px;
        margin-bottom: 35px;
        flex-wrap: wrap;
      }
      .btn {
        background: linear-gradient(135deg, #374151, #4b5563);
        color: #e2e8f0;
        border: none;
        padding: 15px 30px;
        border-radius: 30px;
        cursor: pointer;
        font-size: 1em;
        font-weight: 600;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
      }
      .btn:hover {
        transform: translateY(-3px);
        box-shadow: 0 20px 40px rgba(59, 130, 246, 0.4);
      }
      .btn.active {
        background: linear-gradient(135deg, #3b82f6, #2563eb);
        box-shadow: 0 15px 35px rgba(59, 130, 246, 0.6);
      }
      .data-table {
        background: rgba(15, 23, 42, 0.98);
        backdrop-filter: blur(25px);
        border-radius: 25px;
        padding: 35px;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.6);
        border: 1px solid rgba(59, 130, 246, 0.3);
        overflow-x: auto;
      }
      .table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 25px;
      }
      .table th,
      .table td {
        padding: 18px 25px;
        text-align: left;
        border-bottom: 1px solid rgba(59, 130, 246, 0.2);
      }
      .table th {
        background: linear-gradient(135deg, #1e293b, #334155);
        color: #e2e8f0;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 1px;
        font-size: 0.9em;
      }
      .table tr:hover {
        background: rgba(59, 130, 246, 0.1);
      }
      .warning-row {
        background: rgba(239, 68, 68, 0.1) !important;
      }
      .metric-trend {
        font-size: 0.9em;
        margin-top: 10px;
        font-weight: 500;
      }
      .trend-up {
        color: #ef4444;
      }
      .trend-down {
        color: #22c55e;
      }
      .trend-stable {
        color: #f59e0b;
      }
      .status-indicator {
        padding: 6px 12px;
        border-radius: 15px;
        font-size: 0.8em;
        font-weight: 600;
        text-transform: uppercase;
      }
      .status-normal {
        background: rgba(34, 197, 94, 0.2);
        color: #22c55e;
      }
      .status-warning {
        background: rgba(239, 68, 68, 0.2);
        color: #ef4444;
      }
      /* Enhanced Chatbot styles */
      .chatbot-container {
        position: fixed;
        bottom: 30px;
        right: 30px;
        width: 500px;
        height: 700px;
        background: rgba(15, 23, 42, 0.98);
        backdrop-filter: blur(25px);
        border-radius: 25px;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.8);
        border: 1px solid rgba(59, 130, 246, 0.3);
        z-index: 1000;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        transform: translateY(calc(100% - 80px));
        display: flex;
        flex-direction: column;
      }
      .chatbot-container.expanded {
        transform: translateY(0);
      }
      .chatbot-header {
        background: linear-gradient(135deg, #3b82f6, #2563eb, #1d4ed8);
        color: white;
        padding: 20px 25px;
        border-radius: 25px 25px 0 0;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 15px;
        box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
      }
      .chatbot-header .avatar {
        width: 45px;
        height: 45px;
        background: linear-gradient(135deg, #8b5cf6, #7c3aed);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.4em;
        box-shadow: 0 8px 20px rgba(139, 92, 246, 0.4);
      }
      .chatbot-header .info {
        flex: 1;
      }
      .chatbot-header .name {
        font-weight: 600;
        font-size: 1.1em;
        margin-bottom: 3px;
      }
      .chatbot-header .status {
        font-size: 0.85em;
        opacity: 0.9;
      }
      .chatbot-header .toggle-btn {
        background: rgba(255, 255, 255, 0.2);
        border: none;
        color: white;
        width: 35px;
        height: 35px;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
      }
      .chatbot-header .toggle-btn:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: scale(1.1);
      }
      .chatbot-messages {
        flex: 1;
        padding: 25px;
        overflow-y: auto;
        scrollbar-width: thin;
        scrollbar-color: rgba(59, 130, 246, 0.5) transparent;
      }
      .chatbot-messages::-webkit-scrollbar {
        width: 8px;
      }
      .chatbot-messages::-webkit-scrollbar-track {
        background: transparent;
      }
      .chatbot-messages::-webkit-scrollbar-thumb {
        background: rgba(59, 130, 246, 0.5);
        border-radius: 4px;
      }
      .message {
        margin-bottom: 20px;
        animation: fadeInUp 0.4s ease;
      }
      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translateY(15px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .message.bot {
        display: flex;
        align-items: flex-start;
        gap: 12px;
      }
      .message.user {
        display: flex;
        justify-content: flex-end;
      }
      .message .avatar {
        width: 32px;
        height: 32px;
        background: linear-gradient(135deg, #8b5cf6, #7c3aed);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1em;
        color: white;
        flex-shrink: 0;
        box-shadow: 0 4px 10px rgba(139, 92, 246, 0.3);
      }
      .message .content {
        background: rgba(59, 130, 246, 0.15);
        color: #e2e8f0;
        padding: 15px 20px;
        border-radius: 20px;
        max-width: 320px;
        font-size: 0.95em;
        line-height: 1.6;
        border: 1px solid rgba(59, 130, 246, 0.2);
        word-wrap: break-word;
      }
      .message.user .content {
        background: linear-gradient(135deg, #3b82f6, #2563eb);
        color: white;
        border: none;
        box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
      }
      .chatbot-input {
        padding: 20px 25px;
        border-top: 1px solid rgba(59, 130, 246, 0.2);
        display: flex;
        gap: 12px;
      }
      .chatbot-input input {
        flex: 1;
        background: rgba(59, 130, 246, 0.1);
        border: 1px solid rgba(59, 130, 246, 0.3);
        border-radius: 25px;
        padding: 12px 20px;
        color: #e2e8f0;
        outline: none;
        font-size: 0.95em;
        transition: all 0.3s ease;
      }
      .chatbot-input input:focus {
        border-color: rgba(88, 101, 242, 0.6);
        background: rgba(59, 130, 246, 0.15);
      }
      .chatbot-input input::placeholder {
        color: #64748b;
      }
      .chatbot-input button {
        background: linear-gradient(135deg, #3b82f6, #2563eb);
        border: none;
        color: white;
        width: 45px;
        height: 45px;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4);
      }
      .chatbot-input button:hover {
        transform: scale(1.05);
        box-shadow: 0 6px 20px rgba(59, 130, 246, 0.6);
      }
      .container {
        margin-left: 0;
        padding: 20px;
        max-width: 1200px;
        margin: 0 auto;
        padding-left: 70px;
      }
      .quick-suggestions {
        background: rgba(59, 130, 246, 0.1);
        border-radius: 15px;
        padding: 12px;
        margin-bottom: 15px;
        font-size: 0.85em;
        color: #94a3b8;
        border: 1px solid rgba(59, 130, 246, 0.2);
      }
      .quick-suggestions strong {
        color: #e2e8f0;
        display: block;
        margin-bottom: 8px;
      }
    </style>
  </head>
  <body>
    <div class="app-container">
      <div class="container">
        <div class="main-content">
          <div class="header">
            <div>
              <h1><i class="fas fa-water"></i> H·ªá th·ªëng theo d√µi m·ª±c n∆∞·ªõc</h1>
              <p class="subtitle">Tr∆∞·ªùng ƒë·∫°i h·ªçc Th·ªßy l·ª£i</p>
            </div>
            <button
              class="discord-btn"
              onclick="openDiscordModal()"
              title="Configure Discord Webhook"
            >
              <i class="fab fa-discord"></i>
            </button>
          </div>
          <div class="position-config">
            <h3><i class="fas fa-cog"></i> C√†i ƒë·∫∑t v·ªã tr√≠ ƒë·∫∑t c·∫£m bi·∫øn</h3>
            <div class="position-inputs">
              <div class="input-group">
                <input
                  type="number"
                  id="node1Position"
                  placeholder="Nh·∫≠p v·ªã tr√≠ Node 1"
                  min="0"
                  value="100"
                />
                <span class="unit-label">cm</span>
              </div>
              <div class="input-group">
                <input
                  type="number"
                  id="node2Position"
                  placeholder="Nh·∫≠p v·ªã tr√≠ Node 2"
                  min="0"
                  value="100"
                />
                <span class="unit-label">cm</span>
              </div>
            </div>
            <button class="save-position-btn" onclick="savePositions()">
              <i class="fas fa-save"></i> L∆∞u V·ªã Tr√≠
            </button>
          </div>
          <div class="status-bar">
            <div class="status-card" id="node1Card">
              <div class="icon"><i class="fas fa-ruler-vertical"></i></div>
              <div class="value" id="currentNode1">--cm</div>
              <div class="label">M·ª±c N∆∞·ªõc Node 1</div>
              <div class="metric-trend" id="node1Trend"></div>
              <div
                id="node1Warning"
                style="display: none"
                class="warning-indicator"
              >
                <i class="fas fa-exclamation-triangle"></i> C·∫¢NH B√ÅO
              </div>
            </div>
            <div class="status-card" id="node2Card">
              <div class="icon"><i class="fas fa-ruler-vertical"></i></div>
              <div class="value" id="currentNode2">--cm</div>
              <div class="label">M·ª±c N∆∞·ªõc Node 2</div>
              <div class="metric-trend" id="node2Trend"></div>
              <div
                id="node2Warning"
                style="display: none"
                class="warning-indicator"
              >
                <i class="fas fa-exclamation-triangle"></i> C·∫¢NH B√ÅO
              </div>
            </div>
            <div class="status-card" id="statusCard">
              <div class="icon"><i class="fas fa-shield-alt"></i></div>
              <div class="value" id="systemStatus">NORMAL</div>
              <div
                id="warningIndicator"
                style="display: none"
                class="warning-indicator"
              >
                <i class="fas fa-exclamation-triangle"></i> WARNING
              </div>
            </div>
            <div class="status-card">
              <div class="icon"><i class="fas fa-database"></i></div>
              <div class="value" id="dataCount">--</div>
              <div class="label">Total Records</div>
              <div class="metric-trend">
                <i class="fas fa-clock"></i> Last Update:
                <span id="lastUpdate">--</span>
              </div>
            </div>
          </div>
          <div class="controls">
            <button class="btn active" onclick="showPeriod('day')" id="dayBtn">
              Daily View
            </button>
            <button class="btn" onclick="showPeriod('week')" id="weekBtn">
              Weekly View
            </button>
            <button class="btn" onclick="location.reload()">
              <i class="fas fa-sync-alt"></i> Reset Page
            </button>
          </div>
          <div class="charts-grid">
            <div class="chart-container">
              <h3 class="chart-title">
                <i class="fas fa-ruler-vertical"></i> Node 1 Water Level
                Analytics
              </h3>
              <div class="chart-wrapper">
                <canvas id="temperatureChart"></canvas>
              </div>
            </div>
            <div class="chart-container">
              <h3 class="chart-title">
                <i class="fas fa-ruler-vertical"></i> Node 2 Water Level
                Analytics
              </h3>
              <div class="chart-wrapper">
                <canvas id="humidityChart"></canvas>
              </div>
            </div>
          </div>
          <div class="data-table">
            <h3><i class="fas fa-table"></i> Detailed Data Records</h3>
            <table class="table" id="dataTable">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Timestamp</th>
                  <th>V·ªã tr√≠ Node 1 (cm)</th>
                  <th>M·ª±c n∆∞·ªõc t·∫°i Node1 (cm)</th>
                  <th>Kho·∫£ng c√°ch Sensor Node 1 (cm)</th>
                  <th>V·ªã tr√≠ Node2 (cm)</th>
                  <th>M·ª±c n∆∞·ªõc t·∫°i Node2 (cm)</th>
                  <th>Kho·∫£ng c√°ch Sensor Node 2 (cm)</th>
                </tr>
              </thead>
              <tbody id="tableBody"></tbody>
            </table>
          </div>
        </div>
      </div>
      <div id="discordModal" class="modal">
        <div class="modal-content">
          <h2>üîó Discord Webhook Configuration</h2>
          <p style="color: #94a3b8; margin-bottom: 20px">
            Nh·∫≠p Discord Webhook URL ƒë·ªÉ nh·∫≠n c·∫£nh b√°o khi m·ª±c n∆∞·ªõc th·∫•p
          </p>
          <input
            type="text"
            id="discordWebhookUrl"
            placeholder="https://discord.com/api/webhooks/..."
            value=""
          />
          <div class="discord-status" id="discordStatus"></div>
          <div class="modal-buttons">
            <button class="modal-btn cancel" onclick="closeDiscordModal()">
              H·ªßy
            </button>
            <button class="modal-btn save" onclick="saveDiscordWebhook()">
              L∆∞u
            </button>
          </div>
        </div>
      </div>
      <div class="chatbot-container" id="chatbot">
        <div class="chatbot-header" onclick="toggleChatbot()">
          <div class="avatar"><i class="fas fa-robot"></i></div>
          <div class="info">
            <div class="name">Chat Box H·ªó tr·ª£</div>
            <div class="status">üü¢ Online</div>
          </div>
          <button class="toggle-btn" id="chatbotToggle">
            <i class="fas fa-chevron-down"></i>
          </button>
        </div>
        <div class="chatbot-messages" id="chatMessages">
          <div class="message bot">
            <div class="avatar"><i class="fas fa-robot"></i></div>
            <div class="content">
              üëã Xin ch√†o! T√¥i l√† ARIA Bot, tr·ª£ l√Ω AI ph√¢n t√≠ch m·ª±c n∆∞·ªõc th√¥ng
              minh. T√¥i c√≥ th·ªÉ gi√∫p b·∫°n v·ªõi:<br /><br />
              ‚úÖ <strong>M·ª±c n∆∞·ªõc hi·ªán t·∫°i</strong> - Xem d·ªØ li·ªáu real-time<br />
              ‚úÖ <strong>Th·ªëng k√™ & Ph√¢n t√≠ch</strong> - Trung b√¨nh, max, min<br />
              ‚úÖ <strong>Xu h∆∞·ªõng & So s√°nh</strong> - Ph√¢n t√≠ch thay ƒë·ªïi<br />
              ‚úÖ <strong>Tr·∫°ng th√°i h·ªá th·ªëng</strong> - Ki·ªÉm tra t√¨nh tr·∫°ng<br />
              ‚úÖ <strong>Khuy·∫øn ngh·ªã</strong> - G·ª£i √Ω h√†nh ƒë·ªông<br /><br />
              H√£y h·ªèi: "M·ª±c n∆∞·ªõc hi·ªán t·∫°i?", "Xu h∆∞·ªõng l√† g√¨?", "Tr·∫°ng th√°i h·ªá
              th·ªëng?"
            </div>
          </div>
        </div>
        <div class="chatbot-input">
          <input
            type="text"
            id="messageInput"
            placeholder="Nh·∫≠p c√¢u h·ªèi..."
            onkeypress="handleEnter(event)"
          />
          <button onclick="sendMessage()">
            <i class="fas fa-paper-plane"></i>
          </button>
        </div>
      </div>
    </div>
    <script>
      const SUPABASE_URL = "https://pnrmukosgfcccovskfpf.supabase.co";
      const SUPABASE_ANON_KEY =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBucm11a29zZ2ZjY2NvdnNrZnBmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc4Njk1MzYsImV4cCI6MjA3MzQ0NTUzNn0.d1CbJk3CvjjI4DTP6_XsWuj-ItLObK8Cs4aKhg8xFDc";
      const API_ENDPOINT = `${SUPABASE_URL}/rest/v1/distance?select=*&order=created_at.desc`;
      let node1Position = 100;
      let node2Position = 100;

      // START: C·∫§U H√åNH MQTT
      const MQTT_HOST = "6d24cfbe16584b319b638e75ffc67408.s1.eu.hivemq.cloud";
      const MQTT_PORT = 8884; // WebSocket port (TLS/WSS)
      const MQTT_USERNAME = "hivemq.webclient.1764946653169";
      const MQTT_PASSWORD = "VK;>61uCSXFn8p:wi2q!";
      const MQTT_TOPIC = "duyhiep/alert/level";
      let mqttClient = null;
      let lastAlertLevel = 0; // L∆∞u tr·∫°ng th√°i c·∫£nh b√°o cu·ªëi c√πng ƒë∆∞·ª£c g·ª≠i

      const connectMqtt = () => {
        try {
          // T·∫°o m·ªôt ID Client ng·∫´u nhi√™n ƒë·ªÉ tr√°nh xung ƒë·ªôt
          const clientId =
            "web_dashboard_" + Math.random().toString(16).substr(2, 8);
          // S·ª≠ d·ª•ng Paho MQTT Client, k·∫øt n·ªëi qua WebSockets (wss)
          mqttClient = new Paho.MQTT.Client(
            MQTT_HOST,
            MQTT_PORT,
            "/mqtt", // ƒê∆∞·ªùng d·∫´n m·∫∑c ƒë·ªãnh cho WebSockets
            clientId
          );

          mqttClient.onConnectionLost = onConnectionLost;
          mqttClient.onMessageArrived = onMessageArrived;

          console.log(`Connecting to MQTT broker: ${MQTT_HOST}:${MQTT_PORT}`);

          // T√πy ch·ªçn k·∫øt n·ªëi
          const connectOptions = {
            timeout: 3,
            userName: MQTT_USERNAME,
            password: MQTT_PASSWORD,
            useSSL: true, // B·∫Øt bu·ªôc cho c·ªïng 8884
            onSuccess: onConnect,
            onFailure: (responseObject) => {
              console.error(
                "MQTT Connection failed:",
                responseObject.errorMessage
              );
            },
          };

          mqttClient.connect(connectOptions);
        } catch (error) {
          console.error("L·ªói kh·ªüi t·∫°o MQTT:", error);
        }
      };

      const onConnect = () => {
        console.log("‚úÖ MQTT Client Connected successfully.");
      };

      const onConnectionLost = (responseObject) => {
        if (responseObject.errorCode !== 0) {
          console.log("‚ùå MQTT Connection Lost:", responseObject.errorMessage);
          // Th·ª≠ k·∫øt n·ªëi l·∫°i sau 5 gi√¢y
          setTimeout(connectMqtt, 5000);
        }
      };

      const onMessageArrived = (message) => {
        // Kh√¥ng d√πng cho ch·ª©c nƒÉng n√†y
      };

      /**
       * G·ª≠i m·ª©c c·∫£nh b√°o qua MQTT
       * @param {number} alertLevel - M·ª©c c·∫£nh b√°o (0, 1, 2, 3)
       */
      const sendMqttNotification = (alertLevel) => {
        // Ch·ªâ g·ª≠i n·∫øu m·ª©c c·∫£nh b√°o thay ƒë·ªïi
        if (alertLevel === lastAlertLevel) {
          return;
        }

        if (mqttClient && mqttClient.isConnected()) {
          const messagePayload = alertLevel.toString(); // D·ªØ li·ªáu ch·ªâ l√† s·ªë (0, 1, 2, 3)
          const message = new Paho.MQTT.Message(messagePayload);
          message.destinationName = MQTT_TOPIC;
          message.retained = false;
          message.qos = 0; // Quality of Service

          mqttClient.send(message);
          lastAlertLevel = alertLevel; // C·∫≠p nh·∫≠t tr·∫°ng th√°i cu·ªëi c√πng
          console.log(
            `‚úÖ G·ª≠i MQTT th√†nh c√¥ng: Topic="${MQTT_TOPIC}", Payload="${messagePayload}"`
          );
        } else {
          console.warn(
            "‚ùå Kh√¥ng th·ªÉ g·ª≠i MQTT: Client ch∆∞a k·∫øt n·ªëi ho·∫∑c ƒëang ng·∫Øt k·∫øt n·ªëi. ƒêang th·ª≠ k·∫øt n·ªëi l·∫°i..."
          );
          connectMqtt(); // Th·ª≠ k·∫øt n·ªëi l·∫°i
        }
      };
      // END: C·∫§U H√åNH MQTT

      const savePositions = () => {
        const node1 =
          parseFloat(document.getElementById("node1Position").value) || 100;
        const node2 =
          parseFloat(document.getElementById("node2Position").value) || 100;
        node1Position = node1;
        node2Position = node2;
        localStorage.setItem("node1Position", node1);
        localStorage.setItem("node2Position", node2);
        alert(
          "‚úÖ ƒê√£ l∆∞u v·ªã tr√≠ container:\nNode 1: " +
            node1 +
            " cm\nNode 2: " +
            node2 +
            " cm"
        );
        updateAll();
      };
      const loadPositions = () => {
        const saved1 = localStorage.getItem("node1Position");
        const saved2 = localStorage.getItem("node2Position");
        if (saved1) {
          node1Position = parseFloat(saved1);
          document.getElementById("node1Position").value = node1Position;
        }
        if (saved2) {
          node2Position = parseFloat(saved2);
          document.getElementById("node2Position").value = node2Position;
        }
      };
      const fetchSensorData = async () => {
        try {
          const response = await fetch(API_ENDPOINT, {
            headers: {
              apikey: SUPABASE_ANON_KEY,
              Authorization: `Bearer ${SUPABASE_ANON_KEY}`,
              "Content-Type": "application/json",
            },
          });
          if (!response.ok)
            throw new Error(`HTTP error! status: ${response.status}`);
          const rawData = await response.json();
          if (!rawData || rawData.length === 0) return [];
          const groupedByMinute = {};
          rawData.forEach((item) => {
            const date = new Date(item.created_at);
            const minuteKey = `${date.getFullYear()}-${date.getMonth()}-${date.getDate()}-${date.getHours()}-${date.getMinutes()}`;
            if (!groupedByMinute[minuteKey]) {
              groupedByMinute[minuteKey] = {
                id: item.id,
                distance_node1: 0,
                distance_node2: 0,
                created_at: item.created_at,
                warning: false,
              };
            }
            if (item.node === "NODE1") {
              groupedByMinute[minuteKey].distance_node1 =
                parseFloat(item.distance) || 0;
            } else if (item.node === "NODE2") {
              groupedByMinute[minuteKey].distance_node2 =
                parseFloat(item.distance) || 0;
            }
          });
          const mergedData = Object.values(groupedByMinute)
            .map((item) => {
              const waterLevel1 = node1Position - item.distance_node1;
              const waterLevel2 = node2Position - item.distance_node2;
              return {
                ...item,
                position_node1: node1Position,
                position_node2: node2Position,
                water_level_node1: waterLevel1,
                water_level_node2: waterLevel2,
                warning: waterLevel1 < 20 || waterLevel2 < 20,
              };
            })
            .sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
          return mergedData;
        } catch (error) {
          console.error("Error fetching sensor data:", error);
          return [];
        }
      };
      let sensorData = [];
      let currentPeriod = "day";
      let temperatureChart = null;
      let humidityChart = null;

      const formatDateTimeVietnam = (date) => {
        const day = String(date.getDate()).padStart(2, "0");
        const month = String(date.getMonth() + 1).padStart(2, "0");
        const year = date.getFullYear();
        const hours = String(date.getHours()).padStart(2, "0");
        const minutes = String(date.getMinutes()).padStart(2, "0");
        const seconds = String(date.getSeconds()).padStart(2, "0");
        return `${hours}:${minutes}:${seconds} ${day}/${month}/${year}`;
      };

      /**
       * H√†m getAlertLevel ƒë∆∞·ª£c ƒë∆∞a ra ngo√†i ƒë·ªÉ c√≥ ph·∫°m vi to√†n c·ª•c
       * nh·∫±m kh·∫Øc ph·ª•c l·ªói ReferenceError: getAlertLevel is not defined
       */
      const getAlertLevel = (waterLevel) => {
        if (waterLevel === "--") return 0; // M·ª©c 0: B√¨nh th∆∞·ªùng
        const level = parseFloat(waterLevel);
        if (level > 300) return 3;
        if (level > 200) return 2;
        if (level > 100) return 1;
        return 0; // M·ª©c 0: B√¨nh th∆∞·ªùng
      };

      // Kh·ªüi t·∫°o Charts
      const initCharts = () => {
        const tempCtx = document
          .getElementById("temperatureChart")
          .getContext("2d");
        temperatureChart = new Chart(tempCtx, {
          type: "line",
          data: {
            labels: [],
            datasets: [
              {
                label: "M·ª±c n∆∞·ªõc Node 1 (cm)",
                data: [],
                borderColor: "#3b82f6",
                backgroundColor: "rgba(59, 130, 246, 0.1)",
                borderWidth: 3,
                fill: true,
                tension: 0.4,
                pointRadius: 5,
                pointBackgroundColor: "#3b82f6",
                pointBorderColor: "#fff",
                pointBorderWidth: 2,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                labels: { color: "#e2e8f0", font: { size: 12, weight: "600" } },
              },
            },
            scales: {
              y: {
                beginAtZero: true,
                grid: { color: "rgba(59, 130, 246, 0.1)" },
                ticks: { color: "#94a3b8" },
              },
              x: {
                grid: { color: "rgba(59, 130, 246, 0.1)" },
                ticks: { color: "#94a3b8" },
              },
            },
          },
        });
        const humidityCtx = document
          .getElementById("humidityChart")
          .getContext("2d");
        humidityChart = new Chart(humidityCtx, {
          type: "line",
          data: {
            labels: [],
            datasets: [
              {
                label: "M·ª±c n∆∞·ªõc Node 2 (cm)",
                data: [],
                borderColor: "#8b5cf6",
                backgroundColor: "rgba(139, 92, 246, 0.1)",
                borderWidth: 3,
                fill: true,
                tension: 0.4,
                pointRadius: 5,
                pointBackgroundColor: "#8b5cf6",
                pointBorderColor: "#fff",
                pointBorderWidth: 2,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                labels: { color: "#e2e8f0", font: { size: 12, weight: "600" } },
              },
            },
            scales: {
              y: {
                beginAtZero: true,
                grid: { color: "rgba(59, 130, 246, 0.1)" },
                ticks: { color: "#94a3b8" },
              },
              x: {
                grid: { color: "rgba(59, 130, 246, 0.1)" },
                ticks: { color: "#94a3b8" },
              },
            },
          },
        });
      };

      // C·∫≠p nh·∫≠t Charts
      const updateCharts = (period) => {
        let filteredData = sensorData;
        if (period === "day") {
          const oneDayAgo = new Date(Date.now() - 24 * 60 * 60 * 1000);
          filteredData = sensorData.filter(
            (item) => new Date(item.created_at) > oneDayAgo
          );
        } else if (period === "week") {
          const oneWeekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);
          filteredData = sensorData.filter(
            (item) => new Date(item.created_at) > oneWeekAgo
          );
        }
        const labels = filteredData.map((item) => {
          const date = new Date(item.created_at);
          const hours = String(date.getHours()).padStart(2, "0");
          const minutes = String(date.getMinutes()).padStart(2, "0");
          const seconds = String(date.getSeconds()).padStart(2, "0");
          return `${hours}:${minutes}:${seconds}`;
        });
        const node1Data = filteredData.map((item) => item.water_level_node1);
        const node2Data = filteredData.map((item) => item.water_level_node2);
        temperatureChart.data.labels = labels;
        temperatureChart.data.datasets[0].data = node1Data;
        temperatureChart.update();
        humidityChart.data.labels = labels;
        humidityChart.data.datasets[0].data = node2Data;
        humidityChart.update();
      };

      // C·∫≠p nh·∫≠t Status Cards v√† g·ª≠i c·∫£nh b√°o
      const updateStatusCards = () => {
        if (sensorData.length === 0) return;
        const latestData = sensorData[0];
        const waterLevel1 =
          latestData.water_level_node1 !== undefined &&
          latestData.water_level_node1 !== null
            ? Number(latestData.water_level_node1).toFixed(1)
            : "--";
        const waterLevel2 =
          latestData.water_level_node2 !== undefined &&
          latestData.water_level_node2 !== null
            ? Number(latestData.water_level_node2).toFixed(1)
            : "--";
        document.getElementById("currentNode1").textContent =
          waterLevel1 + " cm";
        document.getElementById("currentNode2").textContent =
          waterLevel2 + " cm";

        const getAlertText = (level) => {
          if (level === 3)
            return '<i class="fas fa-exclamation-circle"></i> C·∫¢NH B√ÅO LVL 3 (>3m)';
          if (level === 2)
            return '<i class="fas fa-exclamation-triangle"></i> C·∫¢NH B√ÅO LVL 2 (>2m)';
          if (level === 1)
            return '<i class="fas fa-exclamation"></i> C·∫¢NH B√ÅO LVL 1 (>1m)';
          return "";
        };

        const node1AlertLevel = getAlertLevel(waterLevel1);
        const node2AlertLevel = getAlertLevel(waterLevel2);

        // X√°c ƒë·ªãnh m·ª©c c·∫£nh b√°o cao nh·∫•t c·ªßa h·ªá th·ªëng
        const maxLevel = Math.max(node1AlertLevel, node2AlertLevel);

        // G·ª¨I C·∫¢NH B√ÅO MQTT
        sendMqttNotification(maxLevel);

        const node1Warning = document.getElementById("node1Warning");
        if (node1AlertLevel > 0) {
          node1Warning.style.display = "inline-block";
          node1Warning.className = `warning-indicator level${node1AlertLevel}`;
          node1Warning.innerHTML = getAlertText(node1AlertLevel);
          // G·ª≠i Discord (ch·ªâ khi c√≥ c·∫£nh b√°o > 0)
          sendDiscordNotification(
            "NODE1",
            waterLevel1,
            node1AlertLevel,
            latestData.created_at
          );
          document.getElementById("node1Card").classList.add("warning");
        } else {
          node1Warning.style.display = "none";
          document.getElementById("node1Card").classList.remove("warning");
        }

        const node2Warning = document.getElementById("node2Warning");
        if (node2AlertLevel > 0) {
          node2Warning.style.display = "inline-block";
          node2Warning.className = `warning-indicator level${node2AlertLevel}`;
          node2Warning.innerHTML = getAlertText(node2AlertLevel);
          // G·ª≠i Discord (ch·ªâ khi c√≥ c·∫£nh b√°o > 0)
          sendDiscordNotification(
            "NODE2",
            waterLevel2,
            node2AlertLevel,
            latestData.created_at
          );
          document.getElementById("node2Card").classList.add("warning");
        } else {
          node2Warning.style.display = "none";
          document.getElementById("node2Card").classList.remove("warning");
        }

        const node1Trend = node1AlertLevel
          ? `<span class="trend-up">‚ö†Ô∏è LEVEL ${node1AlertLevel}</span>`
          : '<span class="trend-down">‚úì Normal</span>';
        const node2Trend = node2AlertLevel
          ? `<span class="trend-up">‚ö†Ô∏è LEVEL ${node2AlertLevel}</span>`
          : '<span class="trend-down">‚úì Normal</span>';
        document.getElementById("node1Trend").innerHTML = node1Trend;
        document.getElementById("node2Trend").innerHTML = node2Trend;

        const hasWarning = maxLevel > 0;
        const statusText =
          maxLevel === 3
            ? "CRITICAL"
            : maxLevel === 2
            ? "WARNING"
            : maxLevel === 1
            ? "CAUTION"
            : "NORMAL";
        document.getElementById("systemStatus").textContent = statusText;

        const warningIndicator = document.getElementById("warningIndicator");
        if (hasWarning) {
          warningIndicator.style.display = "inline-block";
          warningIndicator.className = `warning-indicator level${maxLevel}`;
          warningIndicator.innerHTML = getAlertText(maxLevel);
          document.getElementById("statusCard").classList.add("warning");
        } else {
          warningIndicator.style.display = "none";
          document.getElementById("statusCard").classList.remove("warning");
        }

        document.getElementById("dataCount").textContent = sensorData.length;
        const date = new Date(latestData.created_at);
        const hours = String(date.getHours()).padStart(2, "0");
        const minutes = String(date.getMinutes()).padStart(2, "0");
        const seconds = String(date.getSeconds()).padStart(2, "0");
        document.getElementById(
          "lastUpdate"
        ).textContent = `${hours}:${minutes}:${seconds}`;
      };

      // C·∫≠p nh·∫≠t B·∫£ng D·ªØ li·ªáu
      const updateTable = () => {
        const tableBody = document.getElementById("tableBody");
        tableBody.innerHTML = "";
        sensorData.slice(0, 20).forEach((item, index) => {
          const row = document.createElement("tr");

          // S·ª≠ d·ª•ng h√†m getAlertLevel ·ªü ph·∫°m vi to√†n c·ª•c ƒë·ªÉ ki·ªÉm tra v√† √°p d·ª•ng class
          const level1 = getAlertLevel(item.water_level_node1.toFixed(1));
          const level2 = getAlertLevel(item.water_level_node2.toFixed(1));
          if (level1 > 0 || level2 > 0) row.classList.add("warning-row");

          const timestamp = formatDateTimeVietnam(new Date(item.created_at));
          row.innerHTML = `
            <td>${item.id}</td>
            <td>${timestamp}</td>
            <td>${Number(item.position_node1 || 0).toFixed(1)}</td>
            <td>${Number(item.water_level_node1).toFixed(1)}</td>
            <td>${Number(item.distance_node1).toFixed(1)}</td>
            <td>${Number(item.position_node2 || 0).toFixed(1)}</td>
            <td>${Number(item.water_level_node2).toFixed(1)}</td>
            <td>${Number(item.distance_node2).toFixed(1)}</td>
            `;
          tableBody.appendChild(row);
        });
      };

      const toggleChatbot = () => {
        const chatbot = document.getElementById("chatbot");
        chatbot.classList.toggle("expanded");
        const toggle = document.getElementById("chatbotToggle");
        toggle.innerHTML = chatbot.classList.contains("expanded")
          ? '<i class="fas fa-chevron-down"></i>'
          : '<i class="fas fa-chevron-up"></i>';
      };
      const showPeriod = (period) => {
        currentPeriod = period;
        document
          .querySelectorAll(".controls .btn")
          .forEach((btn) => btn.classList.remove("active"));
        event.target.classList.add("active");
        updateCharts(period);
      };
      const refreshData = async () => {
        sensorData = await fetchSensorData();
        updateAll();
      };
      const updateAll = () => {
        updateStatusCards();
        updateCharts(currentPeriod);
        updateTable();
      };
      const initApp = async () => {
        loadPositions();
        initCharts();
        sensorData = await fetchSensorData();
        updateAll();
        loadDiscordWebhook();
        connectMqtt(); // KH·ªûI T·∫†O K·∫æT N·ªêI MQTT
        setInterval(refreshData, 10000);
      };

      // <CHANGE> Enhanced Discord notification with detailed information
      const sendDiscordNotification = (
        node,
        waterLevel,
        alertLevel,
        timestamp
      ) => {
        const webhookUrl = localStorage.getItem("discordWebhookUrl");
        if (!webhookUrl) return;

        const eventTime = formatDateTimeVietnam(new Date(timestamp));
        const levelDescription =
          alertLevel === 3
            ? "CRITICAL (> 3m)"
            : alertLevel === 2
            ? "WARNING (> 2m)"
            : alertLevel === 1
            ? "CAUTION (> 1m)"
            : "NORMAL";

        const emoji =
          alertLevel === 3
            ? "üî¥"
            : alertLevel === 2
            ? "üü†"
            : alertLevel === 1
            ? "üü°"
            : "üü¢";

        const message = `${emoji} **C·∫¢NH B√ÅO H·ªÜ TH·ªêNG**
    **Node:** ${node}
    **M·ª±c n∆∞·ªõc hi·ªán t·∫°i:** ${waterLevel} cm
    **M·ª©c c·∫£nh b√°o:** ${levelDescription}
    **Th·ªùi gian:** ${eventTime}`;

        fetch(webhookUrl, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ content: message }),
        }).catch((error) => console.error("Error:", error));
      };

      // ... existing code ...

      const loadDiscordWebhook = () => {
        const webhookUrl = localStorage.getItem("discordWebhookUrl");
        if (webhookUrl) {
          document.getElementById("discordWebhookUrl").value = webhookUrl;
          document.getElementById("discordStatus").textContent =
            "‚úÖ Webhook ƒë√£ ƒë∆∞·ª£c c·∫•u h√¨nh";
          document.getElementById("discordStatus").classList.add("connected");
        }
      };
      const saveDiscordWebhook = () => {
        const webhookUrl = document
          .getElementById("discordWebhookUrl")
          .value.trim();
        if (webhookUrl) {
          localStorage.setItem("discordWebhookUrl", webhookUrl);
          document.getElementById("discordStatus").textContent =
            "‚úÖ Webhook ƒë√£ ƒë∆∞·ª£c l∆∞u";
          document.getElementById("discordStatus").classList.add("connected");
        } else {
          localStorage.removeItem("discordWebhookUrl");
          document.getElementById("discordStatus").textContent =
            "‚ùå Webhook kh√¥ng h·ª£p l·ªá";
          document
            .getElementById("discordStatus")
            .classList.remove("connected");
        }
        closeDiscordModal();
      };
      const openDiscordModal = () => {
        document.getElementById("discordModal").style.display = "block";
      };
      const closeDiscordModal = () => {
        document.getElementById("discordModal").style.display = "none";
      };
      const sendMessage = () => {
        const input = document.getElementById("messageInput");
        const userMessage = input.value.trim();
        if (!userMessage) return;
        const messagesDiv = document.getElementById("chatMessages");
        const userMsg = document.createElement("div");
        userMsg.className = "message user";
        userMsg.innerHTML = `<div class="content">${userMessage}</div>`;
        messagesDiv.appendChild(userMsg);
        const botResponse = generateBotResponse(userMessage);
        const botMsg = document.createElement("div");
        botMsg.className = "message bot";
        botMsg.innerHTML = `
            <div class="avatar"><i class="fas fa-robot"></i></div>
            <div class="content">${botResponse.replace(/\n/g, "<br>")}</div>
          `;
        messagesDiv.appendChild(botMsg);
        input.value = "";
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      };
      const handleEnter = (event) => {
        if (event.key === "Enter") sendMessage();
      };

      const getDataStats = () => {
        if (!sensorData || sensorData.length === 0) {
          return null;
        }
        const node1Levels = sensorData.map((item) => item.water_level_node1);
        const node2Levels = sensorData.map((item) => item.water_level_node2);
        return {
          node1: {
            current: node1Levels[0],
            avg: (
              node1Levels.reduce((a, b) => a + b, 0) / node1Levels.length
            ).toFixed(1),
            max: Math.max(...node1Levels).toFixed(1),
            min: Math.min(...node1Levels).toFixed(1),
          },
          node2: {
            current: node2Levels[0],
            avg: (
              node2Levels.reduce((a, b) => a + b, 0) / node2Levels.length
            ).toFixed(1),
            max: Math.max(...node2Levels).toFixed(1),
            min: Math.min(...node2Levels).toFixed(1),
          },
          totalRecords: sensorData.length,
        };
      };
      const getNodeStatus = (nodeNum) => {
        if (!sensorData || sensorData.length === 0) return null;
        const latestData = sensorData[0];
        const waterLevel =
          nodeNum === 1
            ? latestData.water_level_node1
            : latestData.water_level_node2;
        const distance =
          nodeNum === 1 ? latestData.distance_node1 : latestData.distance_node2;

        const alertLevel = getAlertLevel(waterLevel.toFixed(1));
        let status =
          alertLevel === 3
            ? "üî¥ CRITICAL"
            : alertLevel === 2
            ? "üü† WARNING"
            : alertLevel === 1
            ? "üü° CAUTION"
            : "üü¢ NORMAL";

        return {
          node: `Node ${nodeNum}`,
          waterLevel: waterLevel.toFixed(1),
          distance: distance.toFixed(1),
          status: status,
          timestamp: latestData.created_at,
        };
      };
      const getTrend = (nodeNum) => {
        if (!sensorData || sensorData.length < 2) return null;
        const recent = sensorData.slice(0, Math.min(10, sensorData.length));
        const levels =
          nodeNum === 1
            ? recent.map((item) => item.water_level_node1)
            : recent.map((item) => item.water_level_node2);
        const current = levels[0];
        const previous = levels[levels.length - 1];
        const change = (current - previous).toFixed(1);
        const changePercent =
          previous !== 0 ? ((change / previous) * 100).toFixed(1) : "N/A";
        let trend =
          change > 1 ? "üìà TƒÉng" : change < -1 ? "üìâ Gi·∫£m" : "‚û°Ô∏è ·ªîn ƒë·ªãnh";
        return {
          trend: trend,
          change: change,
          changePercent: changePercent,
          current: current.toFixed(1),
          previous: previous.toFixed(1),
        };
      };
      const getComparison = () => {
        const stats = getDataStats();
        if (!stats) return null;
        const diff = Math.abs(
          stats.node1.current - stats.node2.current
        ).toFixed(1);
        const higher =
          stats.node1.current > stats.node2.current ? "Node 1" : "Node 2";
        return {
          node1Current: stats.node1.current.toFixed(1),
          node2Current: stats.node2.current.toFixed(1),
          difference: diff,
          higher: higher,
          avgDiff: Math.abs(stats.node1.avg - stats.node2.avg).toFixed(1),
        };
      };
      const getRecommendations = () => {
        if (!sensorData || sensorData.length === 0)
          return ["üìä Ch∆∞a c√≥ d·ªØ li·ªáu. Vui l√≤ng ch·ªù..."];
        const stats = getDataStats();
        const trend1 = getTrend(1);
        const trend2 = getTrend(2);
        const recommendations = [];
        if (stats.node1.current > 250 || stats.node2.current > 250) {
          recommendations.push(
            "üö® M·ª∞C N∆Ø·ªöC QU√Å CAO - C·∫ßn x·∫£ n∆∞·ªõc ngay l·∫≠p t·ª©c ƒë·ªÉ tr√°nh tr√†n b·ªìn."
          );
        }
        if (stats.node1.current < 50 || stats.node2.current < 50) {
          recommendations.push(
            "‚ö†Ô∏è M·ª∞C N∆Ø·ªöC QU√Å TH·∫§P - C·∫ßn b·ªï sung n∆∞·ªõc ngay l·∫≠p t·ª©c."
          );
        }
        if (
          trend1 &&
          trend1.trend.includes("üìà") &&
          trend2 &&
          trend2.trend.includes("üìà")
        ) {
          recommendations.push(
            "üìà XU H∆Ø·ªöNG TƒÇNG - M·ª±c n∆∞·ªõc ƒëang tƒÉng li√™n t·ª•c. Theo d√µi ch·∫∑t ch·∫Ω ƒë·ªÉ tr√°nh tr√†n."
          );
        }
        if (
          trend1 &&
          trend1.trend.includes("üìâ") &&
          trend2 &&
          trend2.trend.includes("üìâ")
        ) {
          recommendations.push(
            "üìâ XU H∆Ø·ªöNG GI·∫¢M - M·ª±c n∆∞·ªõc ƒëang gi·∫£m. Chu·∫©n b·ªã b·ªï sung n∆∞·ªõc."
          );
        }
        if (Math.abs(stats.node1.current - stats.node2.current) > 50) {
          recommendations.push(
            "üîß CH√äNH L·ªÜCH L·ªöN - C√≥ s·ª± ch√™nh l·ªách l·ªõn gi·ªØa Node 1 v√† Node 2. Ki·ªÉm tra hi·ªáu chu·∫©n c·∫£m bi·∫øn ngay."
          );
        }
        const range1 = stats.node1.max - stats.node1.min;
        const range2 = stats.node2.max - stats.node2.min;
        if (range1 > 100 || range2 > 100) {
          recommendations.push(
            "üìä BI·∫æN ƒê·ªòNG L·ªöN - M·ª±c n∆∞·ªõc bi·∫øn ƒë·ªông r·∫•t nhi·ªÅu. Ki·ªÉm tra h·ªá th·ªëng ƒëi·ªÅu ti·∫øt."
          );
        }
        if (stats.totalRecords > 500) {
          recommendations.push(
            "üíæ D·ªÆ LI·ªÜU L·ªöNO - C∆° s·ªü d·ªØ li·ªáu c√≥ >500 b·∫£n ghi. Xem x√©t sao l∆∞u ho·∫∑c x√≥a d·ªØ li·ªáu c≈©."
          );
        }
        if (recommendations.length === 0) {
          recommendations.push(
            "‚úÖ B√åNH TH∆Ø·ªúNG - H·ªá th·ªëng ho·∫°t ƒë·ªông ·ªïn ƒë·ªãnh. Kh√¥ng c·∫ßn h√†nh ƒë·ªông ngay."
          );
        }
        return recommendations;
      };
      const generateBotResponse = (userMessage) => {
        const lower = userMessage.toLowerCase();
        if (/xin ch√†o|hello|hi|ch√†o|hey|halo/.test(lower)) {
          return "üëã Xin ch√†o! T√¥i l√† ARIA Bot. T√¥i c√≥ th·ªÉ gi√∫p b·∫°n ph√¢n t√≠ch d·ªØ li·ªáu m·ª±c n∆∞·ªõc. H√£y h·ªèi b·∫•t c·ª© ƒëi·ªÅu g√¨ v·ªÅ h·ªá th·ªëng!";
        }
        if (/m·ª±c n∆∞·ªõc hi·ªán t·∫°i|current level|bao nhi√™u|hi·ªán t·∫°i/.test(lower)) {
          const stats = getDataStats();
          if (!stats) return "üìä Ch∆∞a c√≥ d·ªØ li·ªáu. Vui l√≤ng ch·ªù...";
          return `üìè **M·ª±c n∆∞·ªõc hi·ªán t·∫°i:**\n‚Ä¢ Node 1: ${
            stats.node1.current
          }cm\n‚Ä¢ Node 2: ${
            stats.node2.current
          }cm\n\n‚è±Ô∏è C·∫≠p nh·∫≠t l·∫ßn cu·ªëi: ${formatDateTimeVietnam(
            new Date(sensorData[0].created_at)
          )}`;
        }
        if (/trung b√¨nh|average|mean|t√≠nh trung b√¨nh/.test(lower)) {
          const stats = getDataStats();
          if (!stats) return "üìä Ch∆∞a c√≥ d·ªØ li·ªáu. Vui l√≤ng ch·ªù...";
          return `üìä **M·ª±c n∆∞·ªõc trung b√¨nh:**\n‚Ä¢ Node 1: ${stats.node1.avg}cm\n‚Ä¢ Node 2: ${stats.node2.avg}cm\n\n(T√≠nh t·ª´ ${stats.totalRecords} b·∫£n ghi)`;
        }
        if (/max|cao nh·∫•t|th·∫•p nh·∫•t|min|range|ph·∫°m vi/.test(lower)) {
          const stats = getDataStats();
          if (!stats) return "üìä Ch∆∞a c√≥ d·ªØ li·ªáu. Vui l√≤ng ch·ªù...";
          return `üìà **Ph·∫°m vi m·ª±c n∆∞·ªõc:**\n\n**Node 1:**\n‚Ä¢ Cao nh·∫•t: ${stats.node1.max}cm\n‚Ä¢ Th·∫•p nh·∫•t: ${stats.node1.min}cm\n‚Ä¢ Trung b√¨nh: ${stats.node1.avg}cm\n\n**Node 2:**\n‚Ä¢ Cao nh·∫•t: ${stats.node2.max}cm\n‚Ä¢ Th·∫•p nh·∫•t: ${stats.node2.min}cm\n‚Ä¢ Trung b√¨nh: ${stats.node2.avg}cm`;
        }
        if (/xu h∆∞·ªõng|trend|tƒÉng|gi·∫£m|·ªïn ƒë·ªãnh|thay ƒë·ªïi/.test(lower)) {
          const trend1 = getTrend(1);
          const trend2 = getTrend(2);
          if (!trend1) return "üìä Ch∆∞a ƒë·ªß d·ªØ li·ªáu ƒë·ªÉ ph√¢n t√≠ch xu h∆∞·ªõng.";
          return `üìä **Xu h∆∞·ªõng m·ª±c n∆∞·ªõc (10 b·∫£n ghi g·∫ßn nh·∫•t):**\n\n**Node 1:** ${trend1.trend}\n‚Ä¢ Thay ƒë·ªïi: ${trend1.change}cm (${trend1.changePercent}%)\n‚Ä¢ T·ª´: ${trend1.previous}cm ‚Üí ${trend1.current}cm\n\n**Node 2:** ${trend2.trend}\n‚Ä¢ Thay ƒë·ªïi: ${trend2.change}cm (${trend2.changePercent}%)\n‚Ä¢ T·ª´: ${trend2.previous}cm ‚Üí ${trend2.current}cm`;
        }
        if (/so s√°nh|compare|kh√°c nhau|node 1.*node 2|node.*kh√°c/.test(lower)) {
          const comp = getComparison();
          if (!comp) return "üìä Ch∆∞a c√≥ d·ªØ li·ªáu ƒë·ªÉ so s√°nh.";
          return `‚öñÔ∏è **So s√°nh Node 1 v√† Node 2:**\n\n‚Ä¢ Node 1 hi·ªán t·∫°i: ${comp.node1Current}cm\n‚Ä¢ Node 2 hi·ªán t·∫°i: ${comp.node2Current}cm\n‚Ä¢ Ch√™nh l·ªách: ${comp.difference}cm\n‚Ä¢ Node cao h∆°n: ${comp.higher}\n‚Ä¢ Ch√™nh l·ªách trung b√¨nh: ${comp.avgDiff}cm`;
        }
        if (/node 1|n√∫t 1|node1|tr·∫°ng th√°i.*1/.test(lower)) {
          const status = getNodeStatus(1);
          if (!status) return "üìä Ch∆∞a c√≥ d·ªØ li·ªáu Node 1.";
          return `üîç **Tr·∫°ng th√°i Node 1:**\n\n‚Ä¢ M·ª±c n∆∞·ªõc: ${
            status.waterLevel
          }cm\n‚Ä¢ Kho·∫£ng c√°ch sensor: ${status.distance}cm\n‚Ä¢ Tr·∫°ng th√°i: ${
            status.status
          }\n‚Ä¢ C·∫≠p nh·∫≠t: ${formatDateTimeVietnam(new Date(status.timestamp))}`;
        }
        if (/node 2|n√∫t 2|node2|tr·∫°ng th√°i.*2/.test(lower)) {
          const status = getNodeStatus(2);
          if (!status) return "üìä Ch∆∞a c√≥ d·ªØ li·ªáu Node 2.";
          return `üîç **Tr·∫°ng th√°i Node 2:**\n\n‚Ä¢ M·ª±c n∆∞·ªõc: ${
            status.waterLevel
          }cm\n‚Ä¢ Kho·∫£ng c√°ch sensor: ${status.distance}cm\n‚Ä¢ Tr·∫°ng th√°i: ${
            status.status
          }\n‚Ä¢ C·∫≠p nh·∫≠t: ${formatDateTimeVietnam(new Date(status.timestamp))}`;
        }
        if (
          /tr·∫°ng th√°i h·ªá th·ªëng|system status|t·ªïng qu√°t|overview/.test(lower)
        ) {
          const stats = getDataStats();
          if (!stats) return "üìä Ch∆∞a c√≥ d·ªØ li·ªáu. Vui l√≤ng ch·ªù...";
          const systemStatus =
            document.getElementById("systemStatus").textContent;
          return `üõ°Ô∏è **Tr·∫°ng th√°i h·ªá th·ªëng:**\n\n‚Ä¢ Tr·∫°ng th√°i chung: ${systemStatus}\n‚Ä¢ T·ªïng b·∫£n ghi: ${
            stats.totalRecords
          }\n‚Ä¢ Node 1: ${stats.node1.current}cm (TB: ${
            stats.node1.avg
          }cm)\n‚Ä¢ Node 2: ${stats.node2.current}cm (TB: ${
            stats.node2.avg
          }cm)\n\n‚è±Ô∏è C·∫≠p nh·∫≠t: ${formatDateTimeVietnam(
            new Date(sensorData[0].created_at)
          )}`;
        }
        if (/t·ªïng b·∫£n ghi|total record|bao nhi√™u b·∫£n|t·ªïng|record/.test(lower)) {
          const stats = getDataStats();
          if (!stats) return "üìä Ch∆∞a c√≥ d·ªØ li·ªáu.";
          return `üíæ **T·ªïng b·∫£n ghi trong c∆° s·ªü d·ªØ li·ªáu:** ${stats.totalRecords} b·∫£n ghi\n\nD·ªØ li·ªáu n√†y ƒë∆∞·ª£c c·∫≠p nh·∫≠t m·ªói 10 gi√¢y.`;
        }
        if (/khuy·∫øn ngh·ªã|recommendation|n√™n l√†m|g·ª£i √Ω|advice/.test(lower)) {
          const recs = getRecommendations();
          return `üí° **Khuy·∫øn ngh·ªã h√†nh ƒë·ªông:**\n\n${recs
            .map((r) => "‚Ä¢ " + r)
            .join("\n")}`;
        }
        if (/c·∫£nh b√°o|warning|alert|nguy hi·ªÉm|v·∫•n ƒë·ªÅ/.test(lower)) {
          const stats = getDataStats();
          if (!stats) return "üìä Ch∆∞a c√≥ d·ªØ li·ªáu.";
          const warnings = sensorData.filter((item) => item.warning);
          return `‚ö†Ô∏è **T√≥m t·∫Øt c·∫£nh b√°o:**\n\n‚Ä¢ B·∫£n ghi c·∫£nh b√°o: ${
            warnings.length
          }\n‚Ä¢ Node 1 hi·ªán t·∫°i: ${stats.node1.current}cm\n‚Ä¢ Node 2 hi·ªán t·∫°i: ${
            stats.node2.current
          }cm\n‚Ä¢ Tr·∫°ng th√°i: ${
            document.getElementById("systemStatus").textContent
          }`;
        }
        if (/gi√∫p|help|h∆∞·ªõng d·∫´n|guide|t√¥i c√≥ th·ªÉ/.test(lower)) {
          return `üéØ **T√¥i c√≥ th·ªÉ gi√∫p b·∫°n v·ªõi:**\n\n‚úÖ M·ª±c n∆∞·ªõc hi·ªán t·∫°i\n‚úÖ M·ª±c n∆∞·ªõc trung b√¨nh\n‚úÖ M·ª±c n∆∞·ªõc cao nh·∫•t/th·∫•p nh·∫•t\n‚úÖ Xu h∆∞·ªõng m·ª±c n∆∞·ªõc\n‚úÖ So s√°nh Node 1 v√† Node 2\n‚úÖ Tr·∫°ng th√°i t·ª´ng Node\n‚úÖ Tr·∫°ng th√°i h·ªá th·ªëng\n‚úÖ T·ªïng b·∫£n ghi\n‚úÖ Khuy·∫øn ngh·ªã h√†nh ƒë·ªông\n\nüí¨ Th·ª≠ h·ªèi: "M·ª±c n∆∞·ªõc hi·ªán t·∫°i?", "Xu h∆∞·ªõng?", "Khuy·∫øn ngh·ªã?"`;
        }
        return `ü§î T√¥i ch∆∞a hi·ªÉu c√¢u h·ªèi. H√£y h·ªèi v·ªÅ:\n\n‚úÖ M·ª±c n∆∞·ªõc hi·ªán t·∫°i, trung b√¨nh, max/min\n‚úÖ Xu h∆∞·ªõng & So s√°nh\n‚úÖ Tr·∫°ng th√°i Node 1/2\n‚úÖ Tr·∫°ng th√°i h·ªá th·ªëng\n‚úÖ Khuy·∫øn ngh·ªã h√†nh ƒë·ªông\n\nüí¨ Ho·∫∑c g√µ "gi√∫p" ƒë·ªÉ xem danh s√°ch ƒë·∫ßy ƒë·ªß.`;
      };

      initApp();
    </script>
  </body>
</html>
